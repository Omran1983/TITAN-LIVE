<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AZ Agents</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font:14px system-ui,Segoe UI,Arial;margin:24px}
    button{padding:8px 12px;margin:6px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
    pre{background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto}
    textarea{width:100%;height:120px;font-family:ui-monospace,Consolas,monospace}
    select{padding:6px;border-radius:8px;border:1px solid #ccc}
    table{border-collapse:collapse;width:100%;margin-top:16px}
    th,td{border:1px solid #222;padding:6px;text-align:left}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <h1>AZ Agents</h1>
  <div class="row">
    <label for="agent">Agent:</label>
    <select id="agent"></select>
    <button id="btnRun">Run now</button>
    <button id="btnQueue">Run in background</button>
    <button id="btnRefresh">Refresh Jobs</button>
  </div>
  <p>Params (JSON):</p>
  <textarea id="params">{}</textarea>

  <h2>Result</h2>
  <pre id="out">â€”</pre>

  <h2>Jobs</h2>
  <table id="jobs"><thead><tr>
    <th>id</th><th>name</th><th>status</th><th>created</th><th>started</th><th>finished</th><th>error</th>
  </tr></thead><tbody></tbody></table>

<script>
const $ = (q)=>document.querySelector(q);
const api = (p,opts={})=>fetch(p,opts).then(r=>r.json());

async function loadAgents(){
  const j = await api('/api/agents/');
  const sel = $('#agent'); sel.innerHTML='';
  if(!j.ok){ $('#out').textContent='Failed to list agents'; return; }
  j.agents.forEach(a=>{
    const o=document.createElement('option'); o.value=a.name; o.textContent=a.name; sel.appendChild(o);
  });
}

function parseParams(){
  const t = $('#params').value.trim();
  if(!t) return {};
  try{ return JSON.parse(t); } catch(e){ alert('Invalid JSON in params'); throw e; }
}

async function runNow(){
  const name = $('#agent').value; const params = parseParams();
  const j = await api('/api/agents/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,params})});
  $('#out').textContent = JSON.stringify(j, null, 2);
}

async function runBG(){
  const name = $('#agent').value; const params = parseParams();
  const j = await api('/api/agents/run_job',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,params})});
  $('#out').textContent = JSON.stringify(j, null, 2);
  setTimeout(refreshJobs, 800);
}

async function refreshJobs(){
  const j = await api('/api/agents/jobs');
  const tb = $('#jobs tbody'); tb.innerHTML='';
  if(!j.ok){ return; }
  (j.jobs||[]).forEach(row=>{
    const tr=document.createElement('tr');
    ['id','name','status','created_at','started_at','finished_at','error'].forEach(k=>{
      const td=document.createElement('td'); td.textContent=row[k]??''; tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
}

$('#btnRun').onclick = runNow;
$('#btnQueue').onclick = runBG;
$('#btnRefresh').onclick = refreshJobs;

loadAgents().then(refreshJobs);
</script>
</body>
</html>
