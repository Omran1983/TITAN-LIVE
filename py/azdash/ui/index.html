<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AZ Local Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font: 14px/1.4 system-ui,Segoe UI,Arial; margin:20px; color:#eaeaea; background:#121212; }
    .card { background:#1e1e1e; border-radius:12px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,.3); max-width:900px; margin:auto; }
    .row { display:flex; gap:8px; }
    .row input { flex:1; padding:10px; border-radius:10px; border:1px solid #333; background:#111; color:#eaeaea; }
    .row button { padding:10px 14px; border-radius:10px; border:0; background:#2d6cdf; color:white; cursor:pointer; }
    .row button:disabled { background:#444; cursor:not-allowed; }
    #log { height:360px; overflow:auto; padding:10px; border:1px solid #333; border-radius:10px; background:#0c0c0c; }
    .msg-u { color:#a8e6a1; }
    .msg-a { color:#d1d1ff; }
    .hint  { color:#aaa; font-size:12px; margin-top:8px; }
    .ok    { color:#4ade80; }
    .bad   { color:#f87171; }
    .meta  { font-size:12px; color:#bbb; margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="meta">
      <b>AZ Local Chat</b> — talk to AZ locally. Health checked every 10s. Public link later via Named Tunnel.
      <div id="health"></div>
    </div>
    <div id="log"></div>
    <div class="hint">Try: <code>ping</code> · <code>status</code> · <code>cache put foo bar</code> · <code>cache get foo</code></div>
    <div class="row" style="margin-top:10px">
      <input id="msg" placeholder="Type to AZ and hit Enter…"/>
      <button id="send">Send</button>
    </div>
  </div>
<script>
const logEl = document.getElementById('log');
const input = document.getElementById('msg');
const btn   = document.getElementById('send');
const health= document.getElementById('health');

function add(role, text){
  const p = document.createElement('div');
  p.className = role === 'you' ? 'msg-u' : 'msg-a';
  p.innerText = (role==='you' ? 'You: ' : 'AZ: ') + text;
  logEl.appendChild(p);
  logEl.scrollTop = logEl.scrollHeight;
}

async function send(){
  const msg = input.value.trim();
  if(!msg) return;
  add('you', msg);
  input.value=''; btn.disabled = true;
  try{
    const r = await fetch('/api/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({msg})});
    const j = await r.json();
    add('az', j.reply ?? JSON.stringify(j));
  }catch(e){
    add('az', 'Error: ' + e);
  }finally{
    btn.disabled = false;
  }
}

input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
btn.addEventListener('click', send);

async function tick(){
  try{
    const r = await fetch('/api/health', {cache:'no-store'});
    const j = await r.json();
    health.innerHTML = `<span class="ok">●</span> ${new Date().toLocaleString()} — ${j.service} healthy`;
  }catch(e){
    health.innerHTML = `<span class="bad">●</span> ${new Date().toLocaleString()} — offline`;
  }
}
tick(); setInterval(tick, 10000);
</script>
</body>
</html>
