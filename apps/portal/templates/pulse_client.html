<script>
    // TITAN Pulse WebSocket Client (Hybrid Mode)
    // Connects to local WS if avail, else mocks data for Vercel Demo.

    // Detect if we are waiting for value
    const isLocal = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost";
    const PULSE_URL = "ws://127.0.0.1:8000/ws";
    let socket;

    function connectPulse() {
        if (!isLocal) {
            console.log("TITAN Pulse: Production Mode (Mocking Stream)");
            startMockPulse();
            return;
        }

        console.log("TITAN Pulse: Connecting to Local Nervous System...");
        socket = new WebSocket(PULSE_URL);

        socket.onopen = function (e) {
            console.log("TITAN Pulse: CONNECTED");
            addLog("SYSTEM", "Pulse Connected. Listening for nervous system events...", "success");
        };

        socket.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);
                addLog(data.source, `[${data.type}] ${data.message}`, data.severity || 'info');
            } catch (e) {
                console.error("Pulse Parse Error:", e);
            }
        };

        socket.onclose = function (event) {
            if (event.wasClean) {
                addLog("SYSTEM", "Pulse Closed Cleanly", "warn");
            } else {
                addLog("SYSTEM", "Pulse Disconnected. Switching to Simulation Mode...", "error");
                // Fallback to mock on local fail too
                setTimeout(startMockPulse, 2000);
            }
        };

        socket.onerror = function (error) {
            // console.error(`Pulse Error:`, error);
        };
    }

    function startMockPulse() {
        addLog("SYSTEM", "Titan Nervous System: ONLINE (Production Node)", "success");

        const mockMessages = [
            { src: "OBSERVER", msg: "Scanning regulatory updates (UK Standards)...", type: "info" },
            { src: "GUARD", msg: "Security patrol active. Zero threats detected.", type: "success" },
            { src: "KEEPER", msg: "Ledger integrity verified.", type: "info" },
            { src: "TITAN", msg: "Optimization engine ready.", type: "info" },
            { src: "SYSTEM", msg: "Heartbeat: Nominal.", type: "info" }
        ];

        setInterval(() => {
            if (Math.random() > 0.7) {
                const item = mockMessages[Math.floor(Math.random() * mockMessages.length)];
                addLog(item.src, item.msg, item.type);
            }
        }, 5000);
    }

    function addLog(source, message, type) {
        const terminal = document.getElementById('titan-terminal-output');
        if (!terminal) return;

        const line = document.createElement('div');
        line.className = `log-line log-${type}`;

        const timestamp = new Date().toLocaleTimeString();
        line.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="source">${source}:</span> <span class="msg">${message}</span>`;

        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;

        if (terminal.childElementCount > 50) {
            terminal.removeChild(terminal.firstChild);
        }
    }

    // Auto-connect on load
    document.addEventListener("DOMContentLoaded", connectPulse);
</script>

<style>
    #titan-terminal-output {
        background-color: #0d1117;
        color: #c9d1d9;
        font-family: 'Courier New', Courier, monospace;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #30363d;
        border-radius: 6px;
        font-size: 12px;
    }

    .log-line {
        margin-bottom: 4px;
        border-bottom: 1px solid #161b22;
        padding-bottom: 2px;
    }

    .timestamp {
        color: #8b949e;
    }

    .source {
        color: #79c0ff;
        font-weight: bold;
    }

    .msg {
        color: #c9d1d9;
    }

    .log-info .msg {
        color: #c9d1d9;
    }

    .log-warn .msg {
        color: #d29922;
    }

    .log-error .msg {
        color: #ff7b72;
    }

    .log-success .msg {
        color: #3fb950;
    }
</style>

<div class="card mb-4" id="pulse-panel">
    <div class="card-header bg-dark text-white">
        <i class="fas fa-heartbeat text-danger me-2"></i> TITAN Nervous System (Live)
    </div>
    <div class="card-body bg-black p-0">
        <div id="titan-terminal-output">
            <!-- WebSocket logs stream here -->
            <div class="log-line"><span class="timestamp">[SYSTEM]</span> Initializing Pulse Link...</div>
        </div>
    </div>
</div>