{% extends "base.html" %}

{% block content %}
<div class="bg-slate-50 min-h-screen">
    <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">

        <!-- Trust Header -->
        <div
            class="flex justify-center items-center space-x-4 mb-8 text-slate-500 text-xs uppercase tracking-widest font-semibold">
            <span class="flex items-center"><svg class="w-4 h-4 mr-1 text-green-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                    </path>
                </svg> End-to-End Encrypted</span>
            <span class="flex items-center"><svg class="w-4 h-4 mr-1 text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg> Zero-Retention Policy</span>
        </div>

        <div class="text-center">
            <h1 class="text-3xl font-extrabold text-slate-900 sm:text-4xl">
                TITAN <span class="gradient-text">Founder Risk Check</span>
            </h1>
            <p class="mt-4 text-lg text-slate-600">
                Know where your contract can hurt you â€” before it does.
            </p>

            <!-- HOW IT WORKS (Clarity Layer) -->
            <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto text-center">
                <div class="flex flex-col items-center">
                    <div
                        class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600 mb-2">
                        1</div>
                    <h4 class="font-bold text-slate-800 text-sm">Upload Contract</h4>
                    <p class="text-xs text-slate-500 max-w-[200px]">Secure, encrypted tunnel. No data retention.</p>
                </div>
                <div class="flex flex-col items-center">
                    <div
                        class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600 mb-2">
                        2</div>
                    <h4 class="font-bold text-slate-800 text-sm">AI Semantic Scan</h4>
                    <p class="text-xs text-slate-500 max-w-[200px]">We check against 140+ known risk clauses.</p>
                </div>
                <div class="flex flex-col items-center">
                    <div
                        class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600 mb-2">
                        3</div>
                    <h4 class="font-bold text-slate-800 text-sm">Get the Fix</h4>
                    <p class="text-xs text-slate-500 max-w-[200px]">See exactly what to change to be safe.</p>
                </div>
            </div>
        </div>

        <div class="mt-12 max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left: Free Scan -->
            <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="bg-slate-900 px-6 py-4 border-b border-slate-800">
                    <h3 class="text-white font-bold text-lg flex items-center">
                        <span class="bg-green-500 w-2 h-2 rounded-full mr-2"></span> Free Risk Scan
                    </h3>
                    <p class="text-slate-400 text-sm">Upload one contract. See the risks.</p>
                </div>
                <div class="p-8">
                    <div
                        class="border-2 border-dashed border-slate-300 rounded-lg p-10 text-center hover:bg-slate-50 transition-colors cursor-pointer relative">
                        <input id="file-upload" type="file" class="absolute inset-0 opacity-0 cursor-pointer"
                            onchange="handleFileSelect(this)" title="Upload Contract PDF"
                            aria-label="Upload Contract PDF">
                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none"
                            viewBox="0 0 48 48">
                            <path
                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm font-medium text-slate-900" id="fileName">Drop PDF here</p>
                        <p class="mt-1 text-xs text-slate-500">Max 10MB â€¢ Secure Tunnel</p>
                    </div>

                    <!-- Email Gate -->
                    <div class="mt-4">
                        <label for="user-email" class="sr-only">Email address</label>
                        <input type="email" id="user-email" name="email" required
                            class="appearance-none rounded-md relative block w-full px-3 py-2 border border-slate-300 placeholder-slate-500 text-slate-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                            placeholder="Enter your work email (Required for Scan)">
                    </div>

                    <button id="runAuditBtn" onclick="runAudit()"
                        class="mt-6 w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl">
                        Run Free Scan
                    </button>

                    <!-- Legal Disclaimer (Bottom of Card) -->
                    <p class="mt-4 text-[10px] text-slate-400 text-center leading-tight">
                        <strong>Disclaimer:</strong> This tool detects "Risk Indicators" based on semantic analysis. It
                        is
                        <span class="underline">not legal advice</span>. Results should be verified by a qualified
                        attorney.
                        By using this tool, you agree to our Terms of Service.
                    </p>

                    <!-- Download Button (Locked) -->
                    <div id="auditDownload"
                        class="hidden mt-6 text-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm font-bold text-yellow-800 mb-2">ðŸ”’ Report Generated & Encrypted.</p>
                        <p class="text-xs text-yellow-700 mb-4">Your detailed legal analysis is ready. Unlock it below.
                        </p>
                        <!-- PayPal Smart Buttons (Yellow) -->
                        {% if paypal_client_id %}
                        <div id="paypal-button-container-yellow"></div>
                        <script>
                            function renderYellowButton() {
                                if (window.paypal) {
                                    paypal.Buttons({
                                        style: { shape: 'rect', color: 'gold', layout: 'vertical', label: 'pay' },
                                        createOrder: function (data, actions) {
                                            return actions.order.create({
                                                purchase_units: [{
                                                    description: "TITAN Report Unlock (Standard)",
                                                    amount: { value: '49.00' }
                                                }]
                                            });
                                        },
                                        onApprove: function (data, actions) {
                                            return actions.order.capture().then(function (details) {
                                                alert('Unlock successful! Redirecting...');
                                                // TODO: Unlock logic
                                            });
                                        }
                                    }).render('#paypal-button-container-yellow');
                                }
                            }
                            setTimeout(renderYellowButton, 1500);
                        </script>
                        {% else %}
                        <span class="text-xs text-red-500">System Offline</span>
                        {% endif %}
                    </div>
                    <!-- Results (Free) -->
                    <div id="auditResults" class="hidden mt-6 bg-red-50 border border-red-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="uppercase text-xs font-bold text-red-500">Risk Level</span>
                            <span class="text-xl font-black text-red-700" id="resultStatus">HIGH</span>
                        </div>
                        <!-- FIX: removed resultSummary as it was undefined in HTML -->
                        <ul id="findingsList" class="mt-4 space-y-2 text-sm text-red-800"></ul>
                    </div>
                </div>
            </div>

            <!-- Right: Premium Upgrade (Locked initially) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 opacity-75 relative">
                <div class="absolute inset-0 bg-white/50 backdrop-blur-[1px] z-10 hidden" id="premiumLockOverlay"></div>
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 border-b border-transparent">
                    <h3 class="text-white font-bold text-lg flex items-center">
                        <span class="text-yellow-300 mr-2">ðŸ‘‘</span> Premium Repair
                    </h3>
                    <p class="text-blue-100 text-sm">Full Legal Fix & Certification</p>
                </div>
                <div class="p-8 space-y-6">
                    <div class="flex items-start">
                        <div
                            class="flex-shrink-0 h-6 w-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-bold text-xs">
                            âœ“</div>
                        <p class="ml-3 text-sm text-slate-600">Full PDF Report (Line-by-Line Analysis)</p>
                    </div>
                    <div class="flex items-start">
                        <div
                            class="flex-shrink-0 h-6 w-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-bold text-xs">
                            âœ“</div>
                        <p class="ml-3 text-sm text-slate-600">Actionable "Copy-Paste" Clause Fixes</p>
                    </div>
                    <div class="flex items-start">
                        <div
                            class="flex-shrink-0 h-6 w-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 font-bold text-xs">
                            âœ“</div>
                        <p class="ml-3 text-sm text-slate-600">Data Deletion Certificate</p>
                    </div>

                    <div class="pt-6 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-2xl font-bold text-slate-900">$49.00</span>
                            <span class="text-xs text-slate-400 line-through">$200.00</span>
                        </div>
                        <!-- PayPal Smart Buttons Upgrade -->
                        {% if paypal_client_id %}
                        <div id="paypal-button-container-premium"></div>
                        <script
                            src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>
                        <script>
                            function renderPremiumButton() {
                                if (window.paypal) {
                                    paypal.Buttons({
                                        style: { shape: 'rect', color: 'blue', layout: 'vertical', label: 'pay' },
                                        createOrder: function (data, actions) {
                                            return actions.order.create({
                                                purchase_units: [{
                                                    description: "TITAN Premium Repair (Unlock)",
                                                    amount: { value: '49.00' }
                                                }]
                                            });
                                        },
                                        onApprove: function (data, actions) {
                                            return actions.order.capture().then(function (details) {
                                                alert('Transaction completed by ' + details.payer.name.given_name + '!');
                                                // TODO: Call backend to unlock report
                                            });
                                        }
                                    }).render('#paypal-button-container-premium');
                                }
                            }
                            // Render immediately if container is visible, otherwise wait (logic handles visibility elsewhere)
                            setTimeout(renderPremiumButton, 1000); 
                        </script>
                        {% else %}
                        <div class="bg-red-50 p-2 text-xs text-red-600 border border-red-200 rounded">
                            Error: Payment System Offline (Missing Client ID).
                        </div>
                        {% endif %}
                        <p class="text-xs text-center text-slate-400 mt-2">100% Satisfaction Guarantee</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function handleFileSelect(input) {
        const label = document.getElementById('fileName');
        if (input.files && input.files[0]) {
            label.innerText = input.files[0].name;
            label.className = 'mt-2 text-sm font-bold text-blue-600';
        } else {
            label.innerText = "Drop PDF here";
            label.className = 'mt-2 text-sm font-medium text-slate-900';
        }
    }

    async function runAudit() {
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        const btn = document.getElementById('runAuditBtn');
        const results = document.getElementById('auditResults');
        const downloadContainer = document.getElementById('auditDownload');
        const downloadLink = document.getElementById('auditDownloadLink');

        if (!file) {
            alert("Please select a file first.");
            return;
        }

        const email = document.getElementById('user-email').value;
        if (!email || !email.includes('@')) {
            alert("Please enter a valid email address to receive your results.");
            return;
        }

        // Reset UI
        results.classList.add('hidden');
        if (downloadContainer) downloadContainer.classList.add('hidden');

        // Loading State
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing Contract...';

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('email', email);

            const response = await fetch('/api/audit/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.status === 'success') {
                renderResults(data.result);
                results.classList.remove('hidden');

                // Show "Locked" container (No URL provided)
                if (downloadContainer) {
                    downloadContainer.classList.remove('hidden');
                }
            } else {
                alert("Error: " + (data.detail || data.message || "Unknown error"));
            }

        } catch (error) {
            console.error(error);
            alert("Audit failed.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function renderResults(result) {
        // Handle Risk Level
        const riskLevel = result.risk || "UNKNOWN";
        document.getElementById('resultStatus').innerText = riskLevel;
        // Removed missing element: resultSummary

        // Hide score if not present (MVP v2)
        const scoreEl = document.getElementById('resultScore');
        if (result.score !== undefined) {
            scoreEl.innerText = result.score;
        } else {
            scoreEl.style.display = 'none';
        }

        // Color Code Risk
        const scoreContainer = document.getElementById('resultStatus');
        if (riskLevel === "LOW") scoreContainer.className = "text-xs font-semibold uppercase tracking-wide text-green-600 border border-green-200 bg-green-50 px-2 py-1 rounded";
        else if (riskLevel === "MEDIUM") scoreContainer.className = "text-xs font-semibold uppercase tracking-wide text-yellow-600 border border-yellow-200 bg-yellow-50 px-2 py-1 rounded";
        else scoreContainer.className = "text-xs font-semibold uppercase tracking-wide text-red-600 border border-red-200 bg-red-50 px-2 py-1 rounded";

        const list = document.getElementById('findingsList');
        list.innerHTML = '';

        const flags = result.flags || [];

        if (flags.length === 0) {
            list.innerHTML = '<li class="text-sm text-green-600 flex items-center">âœ“ No critical risks found by MVP rules.</li>';
            return;
        }

        flags.forEach(item => {
            const li = document.createElement('li');
            li.className = "bg-red-50 p-3 rounded-md border border-red-100 flex items-start";
            li.innerHTML = `
                <span class="flex-shrink-0 text-red-500 mr-2">âš </span>
                <div>
                    <p class="text-sm font-bold text-red-800">${item.issue} <span class="ml-2 text-xs font-normal px-2 py-0.5 rounded bg-white border border-red-200">${item.severity}</span></p>
                    <p class="text-sm text-red-600 mt-1">${item.evidence || ''}</p>
                </div>
            `;
            list.appendChild(li);
        });

        // Disclaimer info
        if (result.disclaimer) {
            const disc = document.createElement('li');
            disc.className = "text-xs text-slate-400 mt-4 italic";
            disc.innerText = result.disclaimer;
            list.appendChild(disc);
        }
    }
</script>
{% endblock %}