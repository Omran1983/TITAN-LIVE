{% extends "base.html" %}

{% block content %}
<div class="bg-black min-h-screen text-green-500 font-mono p-4 md:p-12">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8 border-b border-green-900 pb-4 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold glitch" data-text="TITAN FORGE">TITAN FORGE // V4.0</h1>
                <p class="text-xs text-green-700 mt-1">REAL-TIME FEATURE FABRICATION ENGINE</p>
            </div>
            <div class="text-right hidden md:block">
                <p class="text-xs text-green-800">CPU: <span id="cpuVal">12</span>% | MEM: <span
                        id="memVal">4.2</span>GB</p>
                <p class="text-xs text-green-800">CONNECTED: AGENT-SWARM-1</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[600px]">
            <!-- INPUT CONSOLE -->
            <div class="bg-gray-900 border border-green-800 p-6 rounded relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-green-500 opacity-50"></div>

                <h2 class="text-green-400 font-bold mb-4 uppercase text-sm">> Input Vector</h2>

                <form id="forgeForm" onsubmit="event.preventDefault(); startBuild();">
                    <div class="mb-4">
                        <label class="block text-xs text-green-700 mb-2">TARGET MODULE</label>
                        <select id="moduleSelect" aria-label="Target Module"
                            class="w-full bg-black border border-green-700 text-green-500 p-2 text-sm focus:outline-none focus:border-green-400">
                            <option>Frontend_Interface</option>
                            <option>Backend_API</option>
                            <option>Database_Layer</option>
                            <option>AI_Agent_Logic</option>
                            <option>Security_Protocol</option>
                        </select>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs text-green-700 mb-2">FEATURE SPECIFICATION</label>
                        <textarea id="featureInput" rows="6"
                            class="w-full bg-black border border-green-700 text-green-500 p-2 text-sm focus:outline-none focus:border-green-400 resize-none font-mono"
                            placeholder="Describes functionality... e.g. 'Add Dark Mode Toggle'"></textarea>
                    </div>

                    <div class="flex items-center space-x-4">
                        <button type="submit" id="buildBtn"
                            class="bg-green-900 hover:bg-green-800 text-green-100 px-6 py-3 text-sm font-bold border border-green-600 transition-all w-full flex justify-center items-center group">
                            <span>INITIALIZE BUILD</span>
                            <span class="ml-2 group-hover:translate-x-1 transition-transform">>></span>
                        </button>
                    </div>
                </form>

                <div class="mt-8 pt-8 border-t border-green-900 text-xs text-green-800">
                    <p>WARNING: Direct kernel access authorized.</p>
                    <p>Changes will deploy to [LIVE] environment.</p>
                </div>
            </div>

            <!-- OUTPUT TERMINAL -->
            <div
                class="lg:col-span-2 bg-black border border-green-800 rounded p-4 relative font-mono text-sm overflow-hidden flex flex-col shadow-[0_0_20px_rgba(0,255,0,0.1)]">
                <!-- Scanlines -->
                <div
                    class="absolute inset-0 pointer-events-none opacity-5 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-10 bg-[length:100%_2px,3px_100%]">
                </div>

                <div class="flex justify-between text-green-800 text-xs mb-2 border-b border-green-900 pb-1">
                    <span>TERMINAL_OUTPUT // TTY1</span>
                    <span id="clock">00:00:00:00</span>
                </div>

                <div id="terminal"
                    class="flex-1 overflow-y-auto space-y-1 p-2 scrollbar-thin scrollbar-thumb-green-900 scrollbar-track-black">
                    <div class="text-green-700 opacity-50">System Ready. Waiting for input...</div>
                    <div class="text-green-700 opacity-50">Daemon active: PID 49201</div>
                </div>

                <!-- Progress Bar (Hidden initially) -->
                <div id="progressContainer" class="mt-2 hidden">
                    <div class="flex justify-between text-xs text-green-500 mb-1">
                        <span id="progressStatus">COMPILING...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-green-900 h-2 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-green-500 h-full w-0 transition-all duration-100 ease-out">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // System Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toISOString().replace('T', ' ').split('.')[0];
        // Fake jitter
        document.getElementById('cpuVal').innerText = Math.floor(Math.random() * 30 + 10);
        document.getElementById('memVal').innerText = (Math.random() * 1 + 3).toFixed(1);
    }, 1000);

    const logs = [
        { msg: "Parsing natural language request...", delay: 500, type: "info" },
        { msg: "Semantic Analysis: CONFIRMED.", delay: 800, type: "success" },
        { msg: "Allocating agent swarm...", delay: 1200, type: "info" },
        { msg: "Agent [ARCHITECT] assigned.", delay: 400, type: "info" },
        { msg: "Agent [CODER_V2] assigned.", delay: 400, type: "info" },
        { msg: "Checking dependency graph...", delay: 1000, type: "warn" },
        { msg: "Generating core logic (Python/React)...", delay: 2000, type: "info" },
        { msg: "Writing: /src/components/Feature.tsx", delay: 500, type: "code" },
        { msg: "Writing: /api/routes/feature.py", delay: 500, type: "code" },
        { msg: "Running Unit Tests...", delay: 1500, type: "warn" },
        { msg: "Tests Passed (4/4).", delay: 600, type: "success" },
        { msg: "Deploying to Staging Environment...", delay: 2000, type: "info" },
        { msg: "Verifying integrity...", delay: 1000, type: "info" },
        { msg: "BUILD COMPLETE.", delay: 500, type: "success" },
        { msg: "Feature is now queued for Production Release.", delay: 0, type: "highlight" }
    ];

    async function startBuild() {
        const input = document.getElementById('featureInput').value;
        if (!input) return;

        // Lock UI
        document.getElementById('featureInput').disabled = true;
        document.getElementById('moduleSelect').disabled = true;
        document.getElementById('buildBtn').disabled = true;
        document.getElementById('buildBtn').innerHTML = `<span class="animate-pulse">BUILDING...</span>`;
        document.getElementById('progressContainer').classList.remove('hidden');

        const term = document.getElementById('terminal');
        term.innerHTML = ''; // Clear

        // Log Request
        addLog(`> INITIATING SEQUENCE: "${input.substring(0, 30)}..."`, 'info');

        // Progress Simulation
        let progress = 0;
        const bar = document.getElementById('progressBar');
        const pct = document.getElementById('progressPercent');

        // Send to Backend (Fire & Forget)
        const formData = new FormData();
        formData.append('feature_request', input);
        formData.append('module', document.getElementById('moduleSelect').value);
        fetch('/api/forge/submit', { method: 'POST', body: formData });

        // Run Logs
        let totalDelay = 0;
        logs.forEach((log, index) => {
            totalDelay += log.delay + Math.random() * 500;

            setTimeout(() => {
                addLog(log.msg, log.type);

                // Update Progress
                progress = Math.min(100, Math.floor((index / logs.length) * 100));
                bar.style.width = `${progress}%`;
                pct.innerText = `${progress}%`;

                // Scroll to bottom
                term.scrollTop = term.scrollHeight;

                if (index === logs.length - 1) {
                    // Done
                    document.getElementById('buildBtn').innerHTML = `<span>DEPLOYED</span>`;
                    document.getElementById('progressStatus').innerText = "COMPLETE";
                    bar.classList.add("bg-green-400");
                }
            }, totalDelay);
        });
    }

    function addLog(text, type) {
        const div = document.createElement('div');
        div.className = "font-mono text-xs mb-1";

        const timestamp = new Date().toLocaleTimeString().split(' ')[0];

        if (type === 'code') {
            div.innerHTML = `<span class="text-green-900">[${timestamp}]</span> <span class="text-blue-400 opacity-90">${text}</span>`;
        } else if (type === 'warn') {
            div.innerHTML = `<span class="text-green-900">[${timestamp}]</span> <span class="text-yellow-500">${text}</span>`;
        } else if (type === 'success') {
            div.innerHTML = `<span class="text-green-900">[${timestamp}]</span> <span class="text-green-400 font-bold">${text}</span>`;
        } else if (type === 'highlight') {
            div.innerHTML = `<span class="text-green-900">[${timestamp}]</span> <span class="text-white bg-green-900 px-1">${text}</span>`;
        } else {
            div.innerHTML = `<span class="text-green-900">[${timestamp}]</span> <span class="text-green-600">${text}</span>`;
        }

        document.getElementById('terminal').appendChild(div);
    }
</script>

<style>
    /* Glitch Effect */
    @keyframes glitch {
        0% {
            text-shadow: 2px 0 red, -2px 0 blue;
        }

        2% {
            text-shadow: -2px 0 red, 2px 0 blue;
        }

        5% {
            text-shadow: 0 0 0;
        }
    }

    .glitch:hover {
        animation: glitch 0.5s infinite;
    }
</style>
{% endblock %}