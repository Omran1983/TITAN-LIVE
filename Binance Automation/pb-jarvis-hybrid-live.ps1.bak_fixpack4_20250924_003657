param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()

  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Stop'

    # TODO: implement your real equity probe (populate $txt or $line)
    $txt = $null   # e.g., content from CLI/API you parse with regex
    $line = $null  # e.g., first line of a pipeline result

    if ($txt) {
      $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
      if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
    } elseif ($line) {
      if ($line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
    } else {
      return 0.0
    }
  }
  catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()

  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Stop'

    # TODO: implement your real equity probe (populate $txt or $line)
    $txt = $null   # e.g., content from CLI/API you parse with regex
    $line = $null  # e.g., first line of a pipeline result

    if ($txt) {
      $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
      if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
    } elseif ($line) {
      if ($line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
    } else {
      return 0.0
    }
  }
  catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    # ensure correct env + UTF-8
    if ($EnvFile) { $env:ENV_FILE = $EnvFile }
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()

    # call balances
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = $out | Out-String

    # robust parse (no pipes that can go empty)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value }
    else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f (param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    $env:ENV_FILE = $EnvFile
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = ($out | Out-String)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

    return 0.0
  }
  finally {
    $ErrorActionPreference = $prevEAP
  }
}function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()

  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Stop'

    # TODO: implement your real equity probe (populate $txt or $line)
    $txt = $null   # e.g., content from CLI/API you parse with regex
    $line = $null  # e.g., first line of a pipeline result

    if ($txt) {
      $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
      if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
    } elseif ($line) {
      if ($line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
    } else {
      return 0.0
    }
  }
  catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    # ensure correct env + UTF-8
    if ($EnvFile) { $env:ENV_FILE = $EnvFile }
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()

    # call balances
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = $out | Out-String

    # robust parse (no pipes that can go empty)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value }
    else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f (param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    $env:ENV_FILE = $EnvFile
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = ($out | Out-String)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

    return 0.0
  }
  finally {
    $ErrorActionPreference = $prevEAP
  }
}function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    # ensure correct env + UTF-8
    if ($EnvFile) { $env:ENV_FILE = $EnvFile }
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()

    # call balances
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = $out | Out-String

    # robust parse (no pipes that can go empty)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value }
    else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f (param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    $env:ENV_FILE = $EnvFile
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = ($out | Out-String)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

    return 0.0
  }
  finally {
    $ErrorActionPreference = $prevEAP
  }
}function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()

  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Stop'

    # TODO: implement your real equity probe (populate $txt or $line)
    $txt = $null   # e.g., content from CLI/API you parse with regex
    $line = $null  # e.g., first line of a pipeline result

    if ($txt) {
      $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
      if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
    } elseif ($line) {
      if ($line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
    } else {
      return 0.0
    }
  }
  catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()

  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Stop'

    # TODO: implement your real equity probe (populate $txt or $line)
    $txt = $null   # e.g., content from CLI/API you parse with regex
    $line = $null  # e.g., first line of a pipeline result

    if ($txt) {
      $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
      if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
    } elseif ($line) {
      if ($line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
    } else {
      return 0.0
    }
  }
  catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    # ensure correct env + UTF-8
    if ($EnvFile) { $env:ENV_FILE = $EnvFile }
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()

    # call balances
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = $out | Out-String

    # robust parse (no pipes that can go empty)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value }
    else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f (param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    $env:ENV_FILE = $EnvFile
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = ($out | Out-String)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

    return 0.0
  }
  finally {
    $ErrorActionPreference = $prevEAP
  }
}function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()

  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Stop'

    # TODO: implement your real equity probe (populate $txt or $line)
    $txt = $null   # e.g., content from CLI/API you parse with regex
    $line = $null  # e.g., first line of a pipeline result

    if ($txt) {
      $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
      if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
    } elseif ($line) {
      if ($line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
    } else {
      return 0.0
    }
  }
  catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    # ensure correct env + UTF-8
    if ($EnvFile) { $env:ENV_FILE = $EnvFile }
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()

    # call balances
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = $out | Out-String

    # robust parse (no pipes that can go empty)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value }
    else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f (param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    $env:ENV_FILE = $EnvFile
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = ($out | Out-String)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

    return 0.0
  }
  finally {
    $ErrorActionPreference = $prevEAP
  }
}function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    # ensure correct env + UTF-8
    if ($EnvFile) { $env:ENV_FILE = $EnvFile }
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()

    # call balances
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = $out | Out-String

    # robust parse (no pipes that can go empty)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value }
    else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f (param(
  [string]$EnvFile = ".env.mainnet",
  [double]$MinBookDepthUSD = 50000,
  [double]$MaxSpreadBps    = 6,
  [int]   $ReselectMinutes  = 10,
  [int]   $MaxConcurrent    = 3

$ErrorActionPreference = "Stop"

$proj     = Split-Path -Parent $MyInvocation.MyCommand.Path
$py       = Join-Path $proj ".venv\Scripts\python.exe"
$kill     = Join-Path $proj "KILL.TRADING"
$stateDir = Join-Path $proj "state"
$logDir   = Join-Path $proj "logs"
New-Item -ItemType Directory -Force -Path $stateDir, $logDir | Out-Null
$statePath = Join-Path $stateDir "jarvis_state.json"

$candidates = @("DOGEUSDT","SHIBUSDT","PEPEUSDT","FLOKIUSDT","BONKUSDT","WIFUSDT")

function Read-State {
  if (Test-Path $statePath) {
    try {
      $obj = Get-Content $statePath -Raw | ConvertFrom-Json
      if ($obj -is [hashtable]) { return $obj }
      $ht = @{}
      if ($obj -ne $null) {
        $obj.PSObject.Properties | ForEach-Object { $ht[$_.Name] = $_.Value }
      }
      return $ht
    } catch {
      return @{}
    }
  } else {
    return @{}
  }
}

function Write-State {
  param($s)
  $s | ConvertTo-Json -Depth 6 | Set-Content -Encoding UTF8 -LiteralPath $statePath
}

function Get-PublicStats {
  param([string]$Sym)
  $base = "https://api.binance.com"
  $t24  = Invoke-RestMethod "$base/api/v3/ticker/24hr?symbol=$Sym"
  $bt   = Invoke-RestMethod "$base/api/v3/ticker/bookTicker?symbol=$Sym"
  $kl   = Invoke-RestMethod "$base/api/v3/klines?symbol=$Sym&interval=1m&limit=30"

  $bid  = [double]$bt.bidPrice
  $ask  = [double]$bt.askPrice
  $mid  = ($bid + $ask)/2
  $spread_bps = if ($mid -ne 0) { ( ($ask - $bid)/$mid ) * 10000 } else { 9999 }

  $rets = @()
  for ($i=1; $i -lt $kl.Count; $i++) {
    $p0 = [double]$kl[$i-1][4]; $p1 = [double]$kl[$i][4]
    if ($p0 -gt 0) { $rets += [math]::Abs(($p1-$p0)/$p0) }
  }
  $vol_bps = if ($rets.Count) { ([double]($rets | Measure-Object -Average).Average) * 10000 } else { 0 }

  $qVol = [double]$t24.quoteVolume
  $avgMinQuote = $qVol / 1440.0
  $depth_ok = ($avgMinQuote -ge $MinBookDepthUSD)

  [pscustomobject]@{
    symbol     = $Sym
    spread_bps = [math]::Round($spread_bps,2)
    vol_bps    = [math]::Round($vol_bps,2)
    qvol_usd_m = [math]::Round($qVol/1e6,2)
    depth_ok   = $depth_ok
  }
}

function Score-Symbol {
  param($st)
  $score  = [math]::Min($st.vol_bps, 120)
  $score += ([math]::Min($st.qvol_usd_m, 50) * 2)
  $score -= ([math]::Min($st.spread_bps, 15) * 2)
  return [math]::Round($score,2)
}

function Get-TopSymbols {
  $stats = @()
  foreach ($s in $candidates) {
    try {
      $st = Get-PublicStats -Sym $s
      if ($st.depth_ok -and ($st.spread_bps -le $MaxSpreadBps)) {
        $st | Add-Member -NotePropertyName score -NotePropertyValue (Score-Symbol $st)
        $stats += $st
      }
    } catch {
      Write-Host ("[WARN] Stats failed for {0} : {1}" -f $s, ($_.Exception.Message) -ForegroundColor Yellow
    }
  }
  $stats | Sort-Object score -Descending | Select-Object -First $MaxConcurrent
}

function Get-EquityUSDT {
  param()
  $prevEAP = $ErrorActionPreference
  try {
    $ErrorActionPreference = 'Continue'
    $env:ENV_FILE = $EnvFile
    $env:PYTHONUTF8 = "1"; $env:PYTHONIOENCODING = "utf-8"
    [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
    $out = & .\.venv\Scripts\python.exe -X utf8 -m scripts.list_balances 2>&1
    $txt = ($out | Out-String)
    $m = [regex]::Match($txt, '(?im)^\s*USDT\s+free\s*=\s*([0-9]+(?:\.\d+)?)')
    if ($m.Success) { return [double]$m.Groups[1].Value } else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}

    return 0.0
  }
  finally {
    $ErrorActionPreference = $prevEAP
  }
}function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }

    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
} else { return 0.0 }
  } catch { return 0.0 } finally { $ErrorActionPreference = $prevEAP }

    if ($line -and $line -match 'free=([0-9\.]+)') { return [double]$Matches[1] } else { return 0.0 }
  } catch {
    Write-Host ("[WARN] Equity probe failed: {0}" -f ($_.Exception.Message) -ForegroundColor Yellow
    return 0.0
  } finally {
    $ErrorActionPreference = $prevEAP
  }
}

function Decide-PositionPct {
  $st = Read-State
  if (-not $st.ContainsKey('baseline_equity')) {
    $eq0 = [double](Get-EquityUSDT); if ($eq0 -le 0) { $eq0 = 100.0 }
    $st['baseline_equity'] = $eq0
  }
  if (-not $st.ContainsKey('pos_pct')) { $st['pos_pct'] = 5.0 }

  $eq = [double](Get-EquityUSDT)
  if ($eq -gt 0) {
    $chg = ($eq - [double]$st['baseline_equity']) / [double]$st['baseline_equity']
    if ($chg -ge 0.03) {
      $st['pos_pct'] = [math]::Min(10.0, [double]$st['pos_pct'] + 0.5)
      $st['baseline_equity'] = $eq
    } elseif ($chg -lt -0.02) {
      $st['pos_pct'] = 5.0
      $st['baseline_equity'] = $eq
    }
  }
  Write-State $st
  return [double]$st['pos_pct']
}

function Decide-CadenceSec {
  param($topStats)
  if (-not $topStats -or $topStats.Count -eq 0) { return 12 }
  $avgVol = [double](($topStats | Measure-Object -Property vol_bps -Average).Average)
  if ($avgVol -ge 60) { 8 } else { 12 }
}

function Drawdown-Hit {
  $st = Read-State
  $utcDay = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd")

  if (-not $st.ContainsKey('dd_day') -or $st['dd_day'] -ne $utcDay) {
    $st['dd_day'] = $utcDay
    $st['dd_open_eq'] = [double](Get-EquityUSDT)
    $st['dd_tripped'] = $false
    Write-State $st
    return $false
  }

  $eqNow = [double](Get-EquityUSDT)
  if ([double]$st['dd_open_eq'] -gt 0) {
    $dd = ($eqNow - [double]$st['dd_open_eq']) / [double]$st['dd_open_eq']
    if ($dd -le -0.025) {
      $st['dd_tripped'] = $true
      Write-State $st
    }
  }
  return [bool]$st['dd_tripped']
}

while ($true) {
  if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
  if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown -2.5% hit. Cooling until UTC reset." -ForegroundColor Yellow; Start-Sleep -Seconds 60; continue }

  $top = Get-TopSymbols
  if (-not $top -or $top.Count -eq 0) { Write-Host "[WAIT] No eligible symbols now." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $posPct   = Decide-PositionPct
  $eqUSDT   = [double](Get-EquityUSDT)
  if ($eqUSDT -le 0) { Write-Host "[WAIT] No USDT free." -ForegroundColor Yellow; Start-Sleep -Seconds 30; continue }

  $cadence  = Decide-CadenceSec -topStats $top
  $tp       = 0.6
  $sl       = 0.5

  Write-Host ("[PICK] {0}" -f (($top.symbol) -join ", ")) -ForegroundColor Cyan
  Write-Host ("[PARAM] equity={0:F2} USDT  pos%={1:F2}%  cadence={2}s  TP={3}% SL={4}%" -f $eqUSDT,$posPct,$cadence,$tp,$sl)

  foreach ($row in $top) {
    $sym   = $row.symbol
    $quote = [math]::Max([math]::Round($eqUSDT * ($posPct/100.0),2), 10.0)
    $log   = Join-Path $logDir ("live_{0}_{1}.log" -f $sym, (Get-Date -f "yyyyMMdd_HHmm"))
    $args  = "--symbol $sym --quote $quote --tp $tp --sl $sl --every $cadence --max-trades $MaxConcurrent"
    & "$proj\pb-run-module-guarded.ps1" -Module "scripts.run_live_trade_safe" -Args $args -EnvFile $EnvFile -LogFile $log
  }

  for ($i=0; $i -lt ($ReselectMinutes*60); $i+=10) {
    if (Test-Path $kill) { Write-Host "[ABORT] Kill-switch present." -ForegroundColor Red; break }
    if (Drawdown-Hit) { Write-Host "[PAUSE] Drawdown hit, skipping new spawns." -ForegroundColor Yellow }
    Start-Sleep -Seconds 10
  }
}


