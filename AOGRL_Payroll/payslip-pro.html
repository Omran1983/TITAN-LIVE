<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AOGRL Payroll — Payslip (Pro)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --brand:#0ea5e9; --bg:#f6f7fb; --ok:#16a34a; --warn:#f59e0b; }
    * { box-sizing:border-box; } html,body{height:100%}
    body { margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Arial; }
    .container { max-width:1040px; margin:28px auto; padding:0 16px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); padding:18px 18px 0 18px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input,button { padding:10px 12px; border-radius:10px; border:1px solid var(--line); }
    button { background:var(--brand); color:#fff; border:0; cursor:pointer; } button:hover { filter:brightness(.95) }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; }
    .muted { color:var(--muted); font-size:12px; } .hidden { display:none !important; }
    hr.sep { border:0; margin:14px 0; border-top:1px solid var(--line); }

    .sheet { width:210mm; min-height:297mm; margin:16px auto; background:#fff; color:var(--ink); position:relative; padding:18mm 16mm; border-radius:12px; }
    .watermark { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .watermark span { font-size:64px; letter-spacing:4px; color:#0002; font-weight:700; transform:rotate(-25deg); }
    .brandbar { display:flex; justify-content:space-between; align-items:center; }
    .logo { display:flex; align-items:center; gap:12px; }
    .avatar { width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg,#22d3ee,#0ea5e9); display:grid; place-items:center; color:white; font-weight:700;}
    .kvs { display:grid; grid-template-columns:160px 1fr; gap:6px 12px; }
    table { width:100%; border-collapse:collapse; } th,td{ padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; }
    th { background:#f9fafb; font-weight:600; } .t-right { text-align:right; }
    .totals { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; margin-top:14px; }
    .totalcard { border:1px solid var(--line); border-radius:12px; padding:12px; }
    .totalcard h4 { margin:0 0 8px 0; font-size:14px; color:#374151; } .total { font-size:22px; font-weight:700; } .net { color:var(--ok); }
    .footer { display:flex; justify-content:space-between; gap:16px; margin-top:18px; font-size:12px; color:var(--muted); }
    .signs { display:flex; gap:24px; margin-top:24px; } .sign { flex:1; height:70px; border-bottom:1px solid var(--line); position:relative; } .sign label { position:absolute; bottom:-18px; left:0; color:var(--muted); font-size:12px; }
    .anomaly { display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:6px 10px; border-radius:999px; }
    .anomaly.warn { background:#fff7ed; color:#9a3412; border:1px solid #fed7aa; }
    .anomaly.ok { background:#ecfdf5; color:#065f46; border:1px solid #bbf7d0; }
    @media print { body{background:#fff} .container,.card,.controls{display:none!important} .sheet{box-shadow:none;border-radius:0;margin:0;width:auto;min-height:auto;padding:12mm} .watermark{opacity:.15} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card controls">
      <div class="row"><strong>Secure Sign-in</strong><span id="authStatus" class="pill">signed out</span></div>
      <div class="row">
        <input id="email" placeholder="email@aogrl.com" />
        <input id="password" placeholder="password" type="password" />
        <button id="signIn">Sign In</button>
        <button id="signOut" class="hidden">Sign Out</button>
        <span id="authMsg" class="muted"></span>
      </div>
      <hr class="sep">
      <div class="row">
        <label><b>Employee Code</b></label>
        <input id="emp" placeholder="E100" value="E100" />
        <button id="fetchBtn">Render Payslip</button>
        <button id="printBtn" class="hidden">Print / Save PDF</button>
        <span id="status" class="pill">idle</span>
      </div>
      <div id="info" class="muted"></div>
    </div>
  </div>

  <div class="sheet hidden" id="sheet">
    <div class="watermark"><span>CONFIDENTIAL</span></div>
    <div class="brandbar">
      <div class="logo">
        <div class="avatar">AO</div>
        <div>
          <div style="font-weight:700; font-size:18px;">A-One Global Resourcing Ltd</div>
          <div class="muted">BRN C22185206 • TAN 28006142 • Mauritius</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700; font-size:18px;">PAYSLIP</div>
        <div class="muted" id="periodLbl"></div>
      </div>
    </div>
    <hr class="sep">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:18px;flex-wrap:wrap;">
      <div class="kvs" style="min-width:300px">
        <b>Employee</b><span id="empName">—</span>
        <b>Employee Code</b><span id="empCode">—</span>
        <b>National ID</b><span id="nid">—</span>
        <b>Bank</b><span id="bank">—</span>
      </div>
      <div><span id="anomalyBadge" class="anomaly ok hidden">No anomalies</span></div>
    </div>
    <hr class="sep">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div>
        <h3 style="margin:0 0 8px 0; font-size:14px;">Earnings</h3>
        <table>
          <thead><tr><th>Component</th><th class="t-right">Amount (MUR)</th></tr></thead>
          <tbody id="earnings"></tbody>
          <tfoot><tr><th>Total Earnings</th><th class="t-right" id="earningsTotal">—</th></tr></tfoot>
        </table>
      </div>
      <div>
        <h3 style="margin:0 0 8px 0; font-size:14px;">Employee Deductions</h3>
        <table>
          <thead><tr><th>Component</th><th class="t-right">Amount (MUR)</th></tr></thead>
          <tbody id="deductions"></tbody>
          <tfoot><tr><th>Total Deductions</th><th class="t-right" id="deductionsTotal">—</th></tr></tfoot>
        </table>
      </div>
    </div>
    <div style="margin-top:16px;">
      <h3 style="margin:0 0 8px 0; font-size:14px;">Employer Contributions</h3>
      <table>
        <thead><tr><th>Component</th><th class="t-right">Amount (MUR)</th></tr></thead>
        <tbody id="employer"></tbody>
        <tfoot><tr><th>Total Employer Costs</th><th class="t-right" id="employerTotal">—</th></tr></tfoot>
      </table>
    </div>
    <div class="totals">
      <div class="totalcard"><h4>Gross Pay</h4><div class="total" id="grossTotal">—</div><div class="muted" id="hoursLine">Hours: —</div></div>
      <div class="totalcard"><h4>Employee Deductions</h4><div class="total" id="deductTotal">—</div><div class="muted">PAYE, CSG, NSF</div></div>
      <div class="totalcard"><h4>Net Pay</h4><div class="total net" id="netTotal">—</div><div class="muted">Payable to employee</div></div>
    </div>
    <div style="display:flex;gap:24px;margin-top:24px;">
      <div class="sign"><label>Prepared By</label></div>
      <div class="sign"><label>Approved By</label></div>
      <div class="sign"><label>Employee Signature</label></div>
    </div>
    <div class="footer">
      <div>Generated by AOGRL Payroll • This payslip is valid without signature.</div>
      <div id="runId" class="muted"></div>
    </div>
  </div>

<script>
const PROJECT_URL = "https://hwwdwmpchgvbypdoabka.supabase.co"; // your project
const ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3d2R3bXBjaGd2YnlwZG9hYmthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3Njg5MzgsImV4cCI6MjA3MTM0NDkzOH0.TFyNIUbvREEcslvtz7bmXogI3O7u6wgGCYXt0bes7t4";                               // paste anon key
const supa = supabase.createClient(PROJECT_URL, ANON);

const el = id => document.getElementById(id);
const show = (id,vis)=> el(id).classList.toggle('hidden', !vis);
const money = v => new Intl.NumberFormat('en-MU',{style:'currency',currency:'MUR'}).format(Number(v||0));
const fmtDate = iso => (new Date(iso)).toLocaleDateString('en-MU',{day:'2-digit',month:'short',year:'numeric'});
const status = t => el("status").textContent = t;

async function refreshAuthUI(){
  const { data:{ user } } = await supa.auth.getUser();
  const signed = !!user;
  el("authStatus").textContent = signed ? "signed in" : "signed out";
  show("signOut", signed);
  status(signed ? "ready" : "idle");
}
el("signIn").onclick = async () => {
  el("authMsg").textContent = "";
  try {
    const { error } = await supa.auth.signInWithPassword({ email: el("email").value.trim(), password: el("password").value });
    if (error) throw error;
  } catch (e) { el("authMsg").textContent = e.message || String(e); return; }
  await refreshAuthUI();
};
el("signOut").onclick = async () => { await supa.auth.signOut(); await refreshAuthUI(); };

function row(label, val){
  const tr = document.createElement("tr");
  const td1 = document.createElement("td"); td1.textContent = label;
  const td2 = document.createElement("td"); td2.textContent = money(val); td2.className = "t-right";
  tr.appendChild(td1); tr.appendChild(td2); return tr;
}

el("fetchBtn").onclick = async () => {
  status("loading...");
  show("sheet", false);
  el("info").textContent = "";
  try {
    const code = el("emp").value.trim();
    const { data, error } = await supa.rpc("get_payslip_latest", { p_employee_code: code });
    if (error) throw error;
    if (!data) throw new Error("No payslip returned");

    el("periodLbl").textContent = `${fmtDate(data.period_start)} — ${fmtDate(data.period_end)}`;
    el("empName").textContent = data.employee_name || "—";
    el("empCode").textContent = data.employee_code || "—";
    el("runId").textContent   = `Run ID: ${data.run_id}`;
    el("nid").textContent     = "—"; // set employees.national_id to show here
    el("bank").textContent    = "—"; // set employees.bank_* to show here

    const anomalies = Number(data.anomalies_in_period||0);
    const ab = document.getElementById("anomalyBadge");
    if (anomalies > 0) { ab.textContent = `${anomalies} anomaly${anomalies>1?"(ies)":"(y)"} in period`; ab.className="anomaly warn"; }
    else { ab.textContent = "No anomalies"; ab.className="anomaly ok"; }
    show("anomalyBadge", true);

    const earnBody = el("earnings"); earnBody.innerHTML = "";
    const grossBasic = Number(data.gross_basic||0);
    const grossOT    = Number(data.gross_overtime||0);
    const allow      = Number(data.allowances||0);
    const otherDed   = Number(data.deductions||0);
    earnBody.appendChild(row("Basic Salary", grossBasic));
    earnBody.appendChild(row("Overtime", grossOT));
    if (allow>0) earnBody.appendChild(row("Allowances", allow));
    const earningsTotal = grossBasic + grossOT + allow;
    el("earningsTotal").textContent = money(earningsTotal);

    const dedBody = el("deductions"); dedBody.innerHTML = "";
    const csgEmp = Number(data.csg_emp||0);
    const nsfEmp = Number(data.nsf_emp||0);
    const paye   = Number(data.paye||0);
    if (paye>0) dedBody.appendChild(row("PAYE", paye));
    if (csgEmp>0) dedBody.appendChild(row("CSG (Employee)", csgEmp));
    if (nsfEmp>0) dedBody.appendChild(row("NSF (Employee)", nsfEmp));
    if (otherDed>0) dedBody.appendChild(row("Other Deductions", otherDed));
    const deductionsTotal = csgEmp + nsfEmp + paye + otherDed;
    el("deductionsTotal").textContent = money(deductionsTotal);

    const empBody = el("employer"); empBody.innerHTML = "";
    const csgEr = Number(data.csg_er||0);
    const nsfEr = Number(data.nsf_er||0);
    const hrdc  = Number(data.hrdc_levy||0);
    const prgf  = Number(data.prgf_er||0);
    if (csgEr>0) empBody.appendChild(row("CSG (Employer)", csgEr));
    if (nsfEr>0) empBody.appendChild(row("NSF (Employer)", nsfEr));
    if (hrdc>0)  empBody.appendChild(row("HRDC Levy", hrdc));
    if (prgf>0)  empBody.appendChild(row("PRGF", prgf));
    const employerTotal = csgEr + nsfEr + hrdc + prgf;
    el("employerTotal").textContent = money(employerTotal);

    el("grossTotal").textContent  = money(earningsTotal);
    el("deductTotal").textContent = money(deductionsTotal);
    el("netTotal").textContent    = money(Number(data.net_pay||0));
    el("hoursLine").textContent   = `Hours: base ${Number(data.base_hours||0)} • OT1.5 ${Number(data.ot_15_hours||0)} • Hol2x ${Number(data.hol_2x_hours||0)} • Hol3x ${Number(data.hol_3x_hours||0)}`;

    show("sheet", true);
    document.getElementById("printBtn").classList.remove("hidden");
    status("done");
  } catch (e) {
    status("error");
    el("info").textContent = e.message || String(e);
    alert("Render failed: " + (e.message || e));
  }
};
document.getElementById("printBtn").onclick = ()=>window.print();
(async () => { await refreshAuthUI(); })();
</script>
</body>
</html>
