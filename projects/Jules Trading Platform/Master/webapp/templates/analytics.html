{% extends "base.html" %}
{% block title %}Analytics{% endblock %}
{% block page_title %}Performance Analytics{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- FINANCIAL STATEMENT (Full Width) -->
    <div class="holo-panel p-6 lg:col-span-2">
        <h2
            class="text-neon-gold font-audiowide tracking-wider text-sm mb-4 flex items-center justify-between border-b border-white/10 pb-2">
            <span>FINANCIAL STATEMENT // FLOW OF FUNDS</span>
            <span id="ledger-net-equity" class="text-xl text-white font-bold">$0.00</span>
        </h2>

        <div class="flex gap-4 mb-4 text-xs font-mono">
            <div class="bg-black/40 p-2 rounded border border-white/10">
                <span class="text-gray-500 block">TOTAL DEPOSITS</span>
                <span id="ledger-deposits" class="text-neon-cyan text-lg">$0.00</span>
            </div>
            <div class="bg-black/40 p-2 rounded border border-white/10">
                <span class="text-gray-500 block">REALIZED PNL</span>
                <span id="ledger-pnl" class="text-white text-lg">$0.00</span>
            </div>
            <div class="bg-black/40 p-2 rounded border border-white/10">
                <span class="text-gray-500 block">TRANSACTIONS</span>
                <span id="ledger-tx-count" class="text-neon-purple text-lg">0</span>
            </div>
        </div>

        <div class="h-64 w-full overflow-y-auto border border-white/5 rounded bg-black/40">
            <table class="w-full text-left font-mono text-xs">
                <thead class="bg-white/5 text-gray-400 sticky top-0 backdrop-blur-md">
                    <tr>
                        <th class="p-3">TIME</th>
                        <th class="p-3">TYPE</th>
                        <th class="p-3">DETAILS</th>
                        <th class="p-3 text-right">AMOUNT</th>
                        <th class="p-3 text-right">BALANCE</th>
                    </tr>
                </thead>
                <tbody id="ledger-body" class="divide-y divide-white/5">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Equity Curve (Full Width) -->
    <div class="holo-panel p-6 lg:col-span-2">
        <h2
            class="text-neon-cyan font-audiowide tracking-wider text-sm mb-4 flex items-center justify-between border-b border-white/10 pb-2">
            <span>EQUITY CURVE // CUMULATIVE PNL</span>
            <i class="fas fa-chart-line"></i>
        </h2>
        <div class="h-96 w-full">
            <canvas id="equityCurveChart"></canvas>
        </div>
    </div>

    <!-- Win / Loss Ratio -->
    <div class="holo-panel p-6">
        <h2 class="text-neon-green font-audiowide tracking-wider text-sm mb-4 border-b border-white/10 pb-2">WIN / LOSS
            RATIO</h2>
        <div class="h-64 w-full flex justify-center">
            <canvas id="winLossChart"></canvas>
        </div>
    </div>

    <!-- PnL Distribution -->
    <div class="holo-panel p-6">
        <h2 class="text-neon-gold font-audiowide tracking-wider text-sm mb-4 border-b border-white/10 pb-2">PNL
            DISTRIBUTION</h2>
        <div class="h-64 w-full">
            <canvas id="pnlHistogramChart"></canvas>
        </div>
    </div>
</div>

<script>
    // Global Chart Configuration for Dark Mode
    Chart.defaults.color = '#9ca3af'; // Tailwind gray-400
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.font.family = "'Inter', sans-serif";

    function renderAnalytics() {
        fetch('/api/analytics_summary')
            .then(response => response.json())
            .then(data => {
                const gridContainer = document.querySelector('.grid');

                if (data.error || !data.equity_curve || data.equity_curve.length === 0) {
                    gridContainer.innerHTML = `
                        <div class="col-span-full glass-panel p-12 text-center text-gray-500">
                            <i class="fa-solid fa-chart-area text-4xl mb-4 text-gray-700"></i>
                            <p>Not enough trade data to generate analytics yet.</p>
                            <p class="text-xs mt-2">Run the trading bot to populate this dashboard.</p>
                        </div>`;
                    return;
                }

                // --- 1. Equity Curve Chart ---
                const equityCtx = document.getElementById('equityCurveChart').getContext('2d');
                // Create gradient
                const gradient = equityCtx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                new Chart(equityCtx, {
                    type: 'line',
                    data: {
                        labels: data.equity_curve.map(d => new Date(d.exit_time).toLocaleDateString()),
                        datasets: [{
                            label: 'Equity ($)',
                            data: data.equity_curve.map(d => d.cumulative_pnl),
                            borderColor: '#3b82f6', // brand-accent
                            backgroundColor: gradient,
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4, // Smooth curve
                            pointRadius: 0,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(22, 27, 34, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { borderDash: [5, 5] } }
                        }
                    }
                });

                // --- 2. Win/Loss Chart ---
                const winLossCtx = document.getElementById('winLossChart').getContext('2d');
                new Chart(winLossCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Wins', 'Losses'],
                        datasets: [{
                            data: data.win_loss_count,
                            backgroundColor: ['#22c55e', '#ef4444'], // brand-success, brand-danger
                            borderColor: '#161b22', // dark-card background
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 20 } }
                        },
                        cutout: '70%'
                    }
                });

                // --- 3. PnL Histogram ---
                const pnlHistCtx = document.getElementById('pnlHistogramChart').getContext('2d');
                new Chart(pnlHistCtx, {
                    type: 'bar',
                    data: {
                        labels: data.pnl_histogram.labels,
                        datasets: [{
                            label: 'Frequency',
                            data: data.pnl_histogram.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: '#3b82f6',
                            borderRadius: 4,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } } },
                            y: { beginAtZero: true }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching analytics data:', error));
    }

    renderAnalytics();
    renderLedger();

    function renderLedger() {
        fetch('/api/ledger')
            .then(res => res.json())
            .then(data => {
                if (data.error) return;

                // Header Stats
                const summary = data.summary;
                document.getElementById('ledger-net-equity').innerText = `$${summary.current_balance.toFixed(2)}`;
                document.getElementById('ledger-pnl').innerText = `$${summary.total_realized_pnl.toFixed(2)}`;
                document.getElementById('ledger-pnl').className = summary.total_realized_pnl >= 0 ? "text-neon-green text-lg" : "text-neon-red text-lg";
                document.getElementById('ledger-tx-count').innerText = summary.transaction_count;

                // Simple Deposit calc (Balance - PnL approx)
                const deposits = summary.current_balance - summary.total_realized_pnl;
                document.getElementById('ledger-deposits').innerText = `$${deposits.toFixed(2)}`;

                // Render Table
                const tbody = document.getElementById('ledger-body');
                tbody.innerHTML = '';

                // Sort by time desc
                const history = data.history.reverse();

                history.forEach(tx => {
                    const time = new Date(tx.timestamp).toLocaleString();
                    const amount = parseFloat(tx.amount);
                    const bal = parseFloat(tx.balance_after);

                    let color = 'text-white';
                    if (tx.type === 'DEPOSIT') color = 'text-neon-cyan';
                    else if (tx.type === 'WITHDRAWAL') color = 'text-orange-500';
                    else if (amount >= 0) color = 'text-neon-green';
                    else color = 'text-neon-red';

                    tbody.innerHTML += `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="p-3 text-gray-500">${time}</td>
                            <td class="p-3 font-bold ${color}">${tx.type}</td>
                            <td class="p-3 text-gray-300">${tx.description}</td>
                            <td class="p-3 text-right font-bold ${color}">${amount > 0 ? '+' : ''}$${amount.toFixed(2)}</td>
                            <td class="p-3 text-right text-gray-400">$${bal.toFixed(2)}</td>
                        </tr>
                    `;
                });
            });
    }
</script>
{% endblock %}