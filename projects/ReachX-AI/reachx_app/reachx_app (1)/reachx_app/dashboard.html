<!-- reachx_app/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ReachX – Dashboard</title>
  <!-- Tailwind CSS for utility classes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js library for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Navigation Bar -->
  <nav class="bg-gray-800 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <span class="font-bold text-xl">ReachX</span>
          </div>
          <div class="ml-10 flex items-baseline space-x-4">
            <a href="index.html" class="hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">Home</a>
            <a href="employers.html" class="hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">Employers</a>
            <a href="dormitories.html" class="hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium">Dormitories</a>
            <a href="dashboard.html" class="bg-gray-900 px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
  <!-- Main content -->
  <main class="flex-1 max-w-7xl mx-auto p-4 w-full">
    <h1 class="text-2xl font-semibold mb-6">Dashboard</h1>
    <!-- Metric cards -->
    <div id="metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <!-- Cards will be populated via JS -->
    </div>
    <!-- Chart container -->
    <div class="bg-white p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">Bed Occupancy</h2>
      <canvas id="occupancyChart" height="200"></canvas>
    </div>
    <!-- Loading & error messages -->
    <p id="loadingMessage" class="mt-6 text-gray-500">Loading dashboard…</p>
    <p id="errorMessage" class="mt-6 text-red-500 hidden"></p>
  </main>
  <script>
    // Configure Supabase with placeholders for the user to replace
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadMetricsAndChart() {
      try {
        // Fetch total employers count
        const { count: employersCount, error: employersError } = await supabaseClient
          .from('employers')
          .select('*', { count: 'exact', head: true });
        if (employersError) throw employersError;

        // Fetch dormitories
        const { data: dormitories, error: dormsError } = await supabaseClient
          .from('dormitories')
          .select('*');
        if (dormsError) throw dormsError;

        // Compute dorm count, total beds, occupied beds
        let dormCount = dormitories.length;
        let totalBeds = 0;
        let occupiedBeds = 0;
        dormitories.forEach((d) => {
          totalBeds += Number(d.capacity ?? d.total_beds ?? 0);
          occupiedBeds += Number(d.occupied_beds ?? d.occupied ?? 0);
        });

        // Build metric cards
        const metricsContainer = document.getElementById('metrics');
        metricsContainer.innerHTML = '';
        const metrics = [
          { name: 'Employers', value: employersCount ?? 0 },
          { name: 'Dormitories', value: dormCount },
          { name: 'Total Beds', value: totalBeds },
          { name: 'Occupied Beds', value: occupiedBeds }
        ];
        metrics.forEach(metric => {
          const card = document.createElement('div');
          card.className = 'bg-white p-4 rounded shadow flex flex-col items-center';
          card.innerHTML = `
            <div class="text-3xl font-bold text-blue-600 mb-2">${metric.value}</div>
            <div class="text-gray-700">${metric.name}</div>
          `;
          metricsContainer.appendChild(card);
        });

        // Render occupancy chart using Chart.js
        const ctx = document.getElementById('occupancyChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Total Beds', 'Occupied Beds'],
            datasets: [
              {
                label: 'Beds',
                data: [totalBeds, occupiedBeds],
                backgroundColor: ['#3b82f6', '#ef4444'],
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 }
              },
            },
          },
        });
      } catch (error) {
        console.error(error);
        document.getElementById('errorMessage').innerText = error.message ?? 'An error occurred while loading data.';
        document.getElementById('errorMessage').classList.remove('hidden');
      } finally {
        document.getElementById('loadingMessage').style.display = 'none';
      }
    }

    loadMetricsAndChart();
  </script>
</body>
</html>